<roblox xmlns:xmime="http://www.w3.org/2005/05/xmlmime" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.roblox.com/roblox.xsd" version="4">
	<External>null</External>
	<External>nil</External>
	<Item class="Script" referent="RBXC5BC586DE75A4002A71E0C2D844FC0F7">
		<Properties>
			<ProtectedString name="Source"><![CDATA[-- FroststrapStudioRPC SDK v1.1.0

local Selection = game:GetService("Selection")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")

local FroststrapStudioRPC = {}
local Plugin = if plugin then plugin else nil

FroststrapStudioRPC.Config = {
	enabled = true,
	httpTimeout = 1
}

local State = {
	lastActivity = "",
	lastPlaceName = "",
	lastTesting = false,
	lastScriptType = "",
	isCooldown = false,
	isInitialized = false,
	selectionChanged = false,
	monitoringThread = nil,
}

local ScriptTypes = {
	SERVER = "server",
	CLIENT = "client",
	SERVER_MODULE = "server_module",
	CLIENT_MODULE = "client_module",
	MODULE = "module",
	UNKNOWN = "unknown",
	DEVELOPING = "developing"
}

local ActivityStates = {
	EDITING = "Editing",
	DESIGNING = "Not In A Script Editor",
}

local Toolbar = nil
local Button = nil

local function trimString(str)
	if not str then return "" end
	return string.match(str, "^%s*(.-)%s*$") or ""
end

local function getScriptLineCount(scriptObj)
	if not scriptObj then return 0 end

	local className = scriptObj.ClassName
	if className ~= "Script" and className ~= "LocalScript" and className ~= "ModuleScript" then
		return 0
	end

	local success, source = pcall(function()
		return scriptObj.Source or ""
	end)

	if not success or source == "" then 
		return 1 
	end

	local lines = 1
	for i = 1, #source do
		if string.sub(source, i, i) == "\n" then
			lines = lines + 1
		end
	end

	return lines
end

local function truncateTextWithWordBoundary(text, maxLength)
	if not text or #text == 0 then return "" end
	text = trimString(text)

	if #text <= maxLength then
		return text
	end

	local truncated = text:sub(1, maxLength - 3)
	local lastSpace = truncated:reverse():find(" ")

	if lastSpace then
		truncated = truncated:sub(1, maxLength - 3 - lastSpace + 1)
	end

	return truncated .. "..."
end

local function sanitizeText(text, maxLength)
	if not text or #text == 0 then return "" end
	text = text:gsub("[\n\r]+", " "):gsub("%s+", " ")
	return truncateTextWithWordBoundary(text, maxLength)
end

local function getSelectedScript()
	if not Plugin then return nil end
	local success, selected = pcall(function()
		return Selection:Get()
	end)
	if not success then return nil end

	local scriptCount = 0
	local foundScript = nil

	for _, obj in ipairs(selected) do
		local className = obj.ClassName
		if className == "Script" or className == "LocalScript" or className == "ModuleScript" then
			scriptCount = scriptCount + 1
			foundScript = obj
		end
	end

	if scriptCount == 1 then
		return foundScript
	end

	return nil
end

local function getScriptType(scriptObj)
	if not scriptObj then return ScriptTypes.DEVELOPING end
	local className = scriptObj.ClassName

	if className == "LocalScript" then
		return ScriptTypes.CLIENT
	elseif className == "Script" then
		local parent = scriptObj.Parent
		while parent do
			local parentName = parent.Name
			if parent:IsA("ServerScriptService") or parent:IsA("ServerStorage") then
				return ScriptTypes.SERVER
			elseif parent:IsA("StarterPlayerScripts") or parent:IsA("StarterCharacterScripts") or
				parent:IsA("StarterGui") or parent:IsA("PlayerScripts") then
				return ScriptTypes.CLIENT
			end
			parent = parent.Parent
		end
		return ScriptTypes.SERVER
	elseif className == "ModuleScript" then
		local parent = scriptObj.Parent
		while parent do
			if parent:IsA("ServerScriptService") or parent:IsA("ServerStorage") then
				return ScriptTypes.SERVER_MODULE
			elseif parent:IsA("StarterPlayerScripts") or parent:IsA("StarterCharacterScripts") or
				parent:IsA("StarterGui") or parent:IsA("PlayerScripts") then
				return ScriptTypes.CLIENT_MODULE
			end
			parent = parent.Parent
		end
		return ScriptTypes.MODULE
	end

	return ScriptTypes.DEVELOPING
end

local function getActivityState()
	local scriptObj = getSelectedScript()
	if not scriptObj then
		return ActivityStates.DESIGNING
	end

	local className = scriptObj.ClassName
	if className ~= "Script" and className ~= "LocalScript" and className ~= "ModuleScript" then
		return ActivityStates.DESIGNING
	end

	return ActivityStates.EDITING
end

local function isTesting()
	local success, result = pcall(function()
		return RunService:IsRunning()
	end)
	return success and result
end

local function getWorkspaceName()
	local success, placeInfo = pcall(function()
		local MarketplaceService = game:GetService("MarketplaceService")
		return MarketplaceService:GetProductInfoAsync(game.PlaceId)
	end)

	if success and placeInfo and placeInfo.Name then
		return placeInfo.Name
	end

	local fallbackSuccess, name = pcall(function()
		return game.Name
	end)

	return if fallbackSuccess and name and #name > 0 then name else "Unknown Workspace"
end

local function formatScriptDisplay(scriptObj)
	if not scriptObj then return "None", ScriptTypes.DEVELOPING end

	local className = scriptObj.ClassName
	if className ~= "Script" and className ~= "LocalScript" and className ~= "ModuleScript" then
		return "Developing", ScriptTypes.DEVELOPING
	end

	local scriptType = getScriptType(scriptObj)
	local prefix = ""
	if scriptType == ScriptTypes.SERVER then
		prefix = "Editing Server - "
	elseif scriptType == ScriptTypes.CLIENT then
		prefix = "Editing Client - "
	elseif scriptType == ScriptTypes.SERVER_MODULE then
		prefix = "Editing Server Module - "
	elseif scriptType == ScriptTypes.CLIENT_MODULE then
		prefix = "Editing Client Module - "
	elseif scriptType == ScriptTypes.MODULE then
		prefix = "Editing Module - "
	end
	return prefix .. scriptObj.Name, scriptType
end

local function collectActivityData()
	if not FroststrapStudioRPC.Config.enabled then return nil end
	local scriptObj = getSelectedScript()
	local activity = getActivityState()
	local testing = isTesting()
	local workspaceName = getWorkspaceName()

	local details = ""
	local state = ""
	local scriptType = ScriptTypes.DEVELOPING

	details = sanitizeText(string.format("Workspace: %s", workspaceName), 128)

	if scriptObj and activity == ActivityStates.EDITING then
		local scriptDisplay, type = formatScriptDisplay(scriptObj)
		scriptType = type
		local lineCount = getScriptLineCount(scriptObj)
		if lineCount > 0 then
			state = sanitizeText(string.format("%s (%d lines)", scriptDisplay, lineCount), 128)
		else
			state = sanitizeText(scriptDisplay, 128)
		end
	else
		state = sanitizeText(activity, 128)
		scriptType = ScriptTypes.DEVELOPING
	end

	return {
		details = details,
		state = state,
		testing = testing,
		scriptType = scriptType,
	}
end

local function hasActivityChanged(newData)
	if not newData then return false end
	return newData.details ~= State.lastActivity or
		newData.state ~= State.lastPlaceName or
		newData.testing ~= State.lastTesting or
		newData.scriptType ~= State.lastScriptType or
		State.selectionChanged
end

local function updateStateCache(newData)
	if not newData then return end
	State.lastActivity = newData.details or ""
	State.lastPlaceName = newData.state or ""
	State.lastTesting = newData.testing or false
	State.lastScriptType = newData.scriptType or ScriptTypes.DEVELOPING
	State.selectionChanged = false
end

local function performPeriodicCheck()
	if not FroststrapStudioRPC.Config.enabled then return end

	local activityData = collectActivityData()
	if not activityData then return end

	if hasActivityChanged(activityData) then
		FroststrapStudioRPC.SendMessage(activityData)
		updateStateCache(activityData)
	end
end

local function startMonitoring()
	if State.monitoringThread then
		return
	end

	State.monitoringThread = task.spawn(function()
		while FroststrapStudioRPC.Config.enabled do
			performPeriodicCheck()
			task.wait(5)
		end
		State.monitoringThread = nil
	end)
end

local function stopMonitoring()
	if State.monitoringThread then
		State.monitoringThread = nil
	end
end

local function sendViaHTTP(jsonString)
	task.spawn(function()
		local url = "http://localhost:4875/rpc"

		local success, result = pcall(function()
			local options = {
				Url = url,
				Method = "POST",
				Headers = {["Content-Type"] = "application/json"},
				Body = jsonString
			}
			local response = HttpService:RequestAsync(options)
			return response.Success and response.StatusCode >= 200 and response.StatusCode < 300
		end)

		return success
	end)
end

local function sendToggleCommand(enabled)
	local toggleMessage = {
		command = "RPCToggle",
		data = {
			enabled = enabled,
			workspace = getWorkspaceName()
		}
	}

	local jsonString
	local success, result = pcall(function()
		return HttpService:JSONEncode(toggleMessage)
	end)

	if not success then
		jsonString = '{"error":"json_encoding_failed"}'
	else
		jsonString = result
	end

	sendViaHTTP(jsonString)
end

function FroststrapStudioRPC.SendMessage(data)
	if not FroststrapStudioRPC.Config.enabled then return end
	if State.isCooldown then return end

	State.isCooldown = true
	task.spawn(function()
		task.wait(1)
		State.isCooldown = false
	end)

	local presenceData = {
		details = data.details or "",
		state = data.state or "",
		testing = data.testing or false,
		scriptType = data.scriptType or ScriptTypes.DEVELOPING,
	}

	local messageToSend = {
		command = "SetRichPresence",
		data = presenceData
	}

	local jsonString
	local success, result = pcall(function()
		return HttpService:JSONEncode(messageToSend)
	end)

	if not success then
		jsonString = '{"error":"json_encoding_failed"}'
	else
		jsonString = result
	end

	sendViaHTTP(jsonString)
end

function FroststrapStudioRPC.UpdatePresence()
	if not FroststrapStudioRPC.Config.enabled then return end
	local activityData = collectActivityData()
	if not activityData then return end
	if hasActivityChanged(activityData) then
		FroststrapStudioRPC.SendMessage(activityData)
		updateStateCache(activityData)
	end
end

function FroststrapStudioRPC.ForceUpdate()
	local activityData = collectActivityData()
	if activityData then
		FroststrapStudioRPC.SendMessage(activityData)
		updateStateCache(activityData)
	end
end

function FroststrapStudioRPC.SetEnabled(enabled)
	FroststrapStudioRPC.Config.enabled = enabled

	sendToggleCommand(enabled)

	if enabled then
		startMonitoring()
		task.wait(0.1)
		FroststrapStudioRPC.ForceUpdate()
		if Button then 
			Button:SetActive(true)
		end
	else
		stopMonitoring()
		if Button then 
			Button:SetActive(false)
		end
	end
end

function FroststrapStudioRPC.Toggle()
	FroststrapStudioRPC.SetEnabled(not FroststrapStudioRPC.Config.enabled)
end

function FroststrapStudioRPC.Initialize()
	if State.isInitialized then return end

	if Plugin then
		Toolbar = Plugin:CreateToolbar("Froststrap RPC")
		Button = Toolbar:CreateButton("RPC", "Toggle RPC Info (Script type, Lines amount, Etc)", "rbxassetid://111400040119373")
		Button.Click:Connect(function()
			FroststrapStudioRPC.Toggle()
		end)
		Button:SetActive(FroststrapStudioRPC.Config.enabled)

		sendToggleCommand(FroststrapStudioRPC.Config.enabled)

		local toggleAction = Plugin:CreatePluginAction(
			"toggle_rpc_command",
			"Toggle RPC",
			"Toggle Rich Presence logging on/off",
			"rbxassetid://111400040119373",
			false
		)

		toggleAction.Triggered:Connect(function()
			FroststrapStudioRPC.Toggle()
		end)

		Plugin.Unloading:Connect(function()
			FroststrapStudioRPC.Cleanup()
		end)
	end

	if Plugin and Selection then
		Selection.SelectionChanged:Connect(function()
			State.selectionChanged = true
			FroststrapStudioRPC.UpdatePresence()
		end)
	end

	if FroststrapStudioRPC.Config.enabled then
		startMonitoring()
		task.wait(0.5)
		FroststrapStudioRPC.ForceUpdate()
	end

	State.isInitialized = true
end

function FroststrapStudioRPC.Cleanup()
	if FroststrapStudioRPC.Config.enabled then
		sendToggleCommand(false)
	end

	stopMonitoring()
	FroststrapStudioRPC.SetEnabled(false)
	State.isInitialized = false
	if Button then
		Button:Destroy()
		Button = nil
	end
	Toolbar = nil
end

if Plugin then
	task.spawn(function()
		FroststrapStudioRPC.Initialize()
	end)
end

return FroststrapStudioRPC]]></ProtectedString>
			<bool name="Disabled">false</bool>
			<Content name="LinkedSource"><null></null></Content>
			<token name="RunContext">0</token>
			<string name="ScriptGuid">{A14B977C-1BEC-4281-9385-C89195ABF89F}</string>
			<BinaryString name="AttributesSerialize"></BinaryString>
			<SecurityCapabilities name="Capabilities">0</SecurityCapabilities>
			<bool name="DefinesCapabilities">false</bool>
			<string name="Name">FroststrapStudioRPC</string>
			<int64 name="SourceAssetId">-1</int64>
			<BinaryString name="Tags"></BinaryString>
		</Properties>
	</Item>
</roblox>